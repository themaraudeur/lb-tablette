import{a9 as te,r as i,u as V,W as se,a1 as P,k as N,J as C,a as s,o as F,p as Q,j as e,L as n,K as le,F as ie,aa as Y,s as ne,ab as re,a4 as ce,ac as oe,i as x,P as de,N as me,ad as ue,ae as he,I as y,a5 as ge,V as fe,af as Ae,h as j,n as ve,ag as Pe,ah as pe}from"./index-BmPcK3sZ.js";var D,B;function Se(){return B||(B=1,D=function(M,a){a=a||{},a.listUnicodeChar=a.hasOwnProperty("listUnicodeChar")?a.listUnicodeChar:!1,a.stripListLeaders=a.hasOwnProperty("stripListLeaders")?a.stripListLeaders:!0,a.gfm=a.hasOwnProperty("gfm")?a.gfm:!0,a.useImgAltText=a.hasOwnProperty("useImgAltText")?a.useImgAltText:!0,a.abbr=a.hasOwnProperty("abbr")?a.abbr:!1,a.replaceLinksWithURL=a.hasOwnProperty("replaceLinksWithURL")?a.replaceLinksWithURL:!1,a.htmlTagsToSkip=a.hasOwnProperty("htmlTagsToSkip")?a.htmlTagsToSkip:[],a.throwError=a.hasOwnProperty("throwError")?a.throwError:!1;var c=M||"";c=c.replace(/^(-\s*?|\*\s*?|_\s*?){3,}\s*/gm,"");try{a.stripListLeaders&&(a.listUnicodeChar?c=c.replace(/^([\s\t]*)([\*\-\+]|\d+\.)\s+/gm,a.listUnicodeChar+" $1"):c=c.replace(/^([\s\t]*)([\*\-\+]|\d+\.)\s+/gm,"$1")),a.gfm&&(c=c.replace(/\n={2,}/g,`
`).replace(/~{3}.*\n/g,"").replace(/~~/g,"").replace(/`{3}.*\n/g,"")),a.abbr&&(c=c.replace(/\*\[.*\]:.*\n/,"")),c=c.replace(/<[^>]*>/g,"");var h=new RegExp("<[^>]*>","g");if(a.htmlTagsToSkip.length>0){var L="(?!"+a.htmlTagsToSkip.join("|")+")";h=new RegExp("<"+L+"[^>]*>","ig")}c=c.replace(h,"").replace(/^[=\-]{2,}\s*$/g,"").replace(/\[\^.+?\](\: .*?$)?/g,"").replace(/\s{0,2}\[.*?\]: .*?$/g,"").replace(/\!\[(.*?)\][\[\(].*?[\]\)]/g,a.useImgAltText?"$1":"").replace(/\[([^\]]*?)\][\[\(].*?[\]\)]/g,a.replaceLinksWithURL?"$2":"$1").replace(/^(\n)?\s{0,3}>\s?/gm,"$1").replace(/^\s{1,2}\[(.*?)\]: (\S+)( ".*?")?\s*$/g,"").replace(/^(\n)?\s{0,}#{1,6}\s*( (.+))? +#+$|^(\n)?\s{0,}#{1,6}\s*( (.+))?$/gm,"$1$3$4$6").replace(/([\*]+)(\S)(.*?\S)??\1/g,"$2$3").replace(/(^|\W)([_]+)(\S)(.*?\S)??\2($|\W)/g,"$1$3$4$5").replace(/(`{3,})(.*?)\1/gm,"$2").replace(/`(.+?)`/g,"$1").replace(/~(.*?)~/g,"$1")}catch(p){if(a.throwError)throw p;return console.error("remove-markdown encountered error: %s",p),M}return c}),D}var Me=Se();const we=te(Me),J={address:"mail@lbphone.com",mails:[{id:"1",to:"mail@lbphone.com",sender:"breze@lbphone.com",read:!0,subject:"Meeting appointment",message:"Hello, I would like to **schedule a meeting with you.** Please let me know when you are available.",timestamp:Date.now()-1e3*60*60},{id:"2",to:"mail@lbphone.com",sender:"loaf@lbphone.com",read:!1,subject:"Look at these puppies!",message:"I was at a pet store earlier today and saw these cute puppies. I thought you might like them too. Here's a picture of them.",attachments:["https://media.cnn.com/api/v1/images/stellar/prod/210602230802-01-puppy-social-skills-wellness-sci.jpg?q=w_1600,h_1453,x_0,y_0,c_fill","https://media.licdn.com/dms/image/D5612AQE2GQkfwc73Jw/article-cover_image-shrink_720_1280/0/1697343821040?e=2147483647&v=beta&t=qRaJYBtAZy7jRde_A4P5dF8yK9uWNSxQpM9nkW96Nv8"],timestamp:Date.now()-1e3*60*60},{id:"3",to:"mail@lbphone.com",sender:"system@lbphone.com",read:!1,subject:"Action required",message:"Please verify your email address.",actions:[{label:"Verify",data:"verify-email"}],timestamp:Date.now()-1e3*60*60},{id:"4",to:"mail@lbphone.com",sender:"system@lbphone.com",read:!1,subject:"Markdown support",message:"Our *mail* app **supports** __markdown__.",timestamp:Date.now()-1e3*60*60}]};function Ne(){var q;const{Email:M,View:a,Mails:c,ShowNewMail:h,LoggedIn:L,fetchAndSetMail:p}=i.useContext(k),[g,r]=M,[o,f]=c,[S,t]=a,[I,v]=h,[u,d]=L,m=(q=V(de))==null?void 0:q.active,[A,O]=i.useState(""),[W,z]=i.useState(""),[_,R]=i.useState([]),[ye,K]=i.useState(0),[X,$]=i.useState(!1),[Z,U]=i.useState(!1);i.useEffect(()=>{if(se("Mail")){if(P.APPS.MAIL.recentmails.value)return f(P.APPS.MAIL.recentmails.value);N("Mail",{action:"getMails"},J.mails).then(l=>{if(!l)return C("warning","No mails found");f(l),P.APPS.MAIL.recentmails.set(l)})}},[]),i.useEffect(()=>{const l=setTimeout(()=>O(W),500);return()=>clearTimeout(l)},[W]),i.useEffect(()=>{A.length>0?N("Mail",{action:"search",query:A},J.mails.filter(l=>l.subject.toLowerCase().includes(A.toLowerCase())||l.message.toLowerCase().includes(A.toLocaleLowerCase()))).then(l=>{l&&R(l)}):(R([]),K(0))},[A]);let G=i.useRef(!1);i.useEffect(()=>{var l,E;G.current||m!=null&&m.data&&(G.current=!0,m!=null&&m.data&&((l=m.data)==null?void 0:l.view)=="newMail"&&v({to:(E=m.data)==null?void 0:E.recipient}))},[m==null?void 0:m.data]);const ee=l=>{var w,H;if(Z||X)return;let E=document.querySelector("#last");if(!E)return;!oe(E)&&(A.length>0?($(!0),N("Mail",{action:"search",query:A,lastId:(w=_[_.length-1])==null?void 0:w.id}).then(b=>{b&&b.length>0?(R([...o,..._]),$(!1)):U(!0)})):($(!0),N("Mail",{action:"getMails",lastId:(H=o[o.length-1])==null?void 0:H.id}).then(b=>{b&&b.length>0?(f([...o,...b]),$(!1),b.length<10&&U(!0)):U(!0)})))},ae=()=>{N("AccountSwitcher",{action:"getAccounts",app:"Mail"},null).then(l=>{var T;if(!l)return C("info","No accounts found");let E=(T=l==null?void 0:l.filter(w=>w!==g))==null?void 0:T.map(w=>({title:w,cb:()=>{N("AccountSwitcher",{action:"switch",app:"Mail",account:w}).then(()=>{P.APPS.MAIL.address.set(w),P.APPS.MAIL.recentmails.set(null),r(w),t("refresh")})}}));x.ContextMenu.set({buttons:[{title:g},...E,{title:n("APPS.MAIL.ADD_EMAIL"),cb:()=>{d(!1),t("login")}},{title:n("APPS.MAIL.SIGN_OUT_POPUP.TITLE"),color:"red",cb:()=>{x.PopUp.set({title:n("APPS.MAIL.SIGN_OUT_POPUP.TITLE"),description:n("APPS.MAIL.SIGN_OUT_POPUP.DESCRIPTION"),buttons:[{title:n("APPS.MAIL.SIGN_OUT_POPUP.CANCEL")},{title:n("APPS.MAIL.SIGN_OUT_POPUP.PROCEED"),color:"red",cb:()=>{N("Mail",{action:"logout"},!0).then(w=>{w!=null&&w.success&&(t("login"),d(!1),r(null),P.APPS.MAIL.address.reset())})}}]})}}]})})};return s(F.div,{...Q("left","home"),className:"animation-container home",children:[e("div",{className:"mail-header",children:e("div",{className:"title",children:n("APPS.MAIL.TITLE")})}),e(le,{placeholder:n("SEARCH"),onChange:l=>z(l.target.value)}),e("div",{className:"mail-list",onScroll:ee,children:(A.length>0?_:o).map((l,E)=>{let T=E===o.length-1?"last":"";return s("div",{id:T,className:"mail",onClick:()=>p(l),children:[s("div",{className:"item-header",children:[s("div",{className:"user",children:[e("div",{className:"symbol","data-read":(l.read||l.sender===g)??!1}),e("div",{className:"sender",children:l.sender===g?s(ie,{children:[n("APPS.MAIL.YOU"),s("span",{children:["- ",l.to]})]}):l.sender})]}),s("div",{className:"date",children:[e("div",{className:"time",children:Y(l.timestamp)}),e(ne,{})]})]}),s("div",{className:"item-body",children:[e("div",{className:"subject",children:l.subject}),e("div",{className:"message",children:we(l.message.length>70?l.message.substring(0,70)+"...":l.message)})]})]},E)})}),e("div",{className:"mail-footer",children:s("div",{className:"footer-wrapper",children:[e(re,{onClick:ae}),s("div",{className:"text",children:[e("div",{className:"title",children:g}),s("div",{className:"count",children:[o.filter(l=>!l.read&&g!==l.sender).length," ",n("APPS.MAIL.UNREAD")]})]}),e(ce,{onClick:()=>v(!0)})]})})]})}function Ie(){const{Email:M,View:a,SelectedMail:c,ShowNewMail:h}=i.useContext(k),[L,p]=a,[g]=M,[r]=c,[o,f]=h;return s(F.div,{...Q("right","mail"),className:"animation-container",children:[e("div",{className:"mail-header",children:s("div",{className:"left",onClick:()=>p("home"),children:[e(me,{}),n("APPS.MAIL.INBOX")]})}),s("div",{className:"mail-wrapper",children:[s("div",{className:"item-header",children:[s("div",{className:"user",children:[e("div",{className:"name",children:r.sender}),s("div",{className:"to",children:[s("span",{children:[n("APPS.MAIL.TO"),":"]})," ",r.to]})]}),e("div",{className:"date",children:Y(r.timestamp)})]}),e("div",{className:"item subject",children:r.subject}),e("div",{className:"item message",children:e(ue,{children:r.message})}),r.attachments&&r.attachments.length>0&&e("div",{className:"item attachments",children:r.attachments.map((S,t)=>e("div",{className:"attachment",onClick:()=>x.FullscreenImage.set(S),children:e("img",{src:S})},t))}),r.actions&&e("div",{className:"item actions",children:r.actions.map((S,t)=>e("div",{className:"action",onClick:()=>{N("Mail",{action:"action",id:r.id,actionId:t})},children:S.label},t))})]}),e("div",{className:"mail-footer",children:s("div",{className:"footer-wrapper",children:[e("span",{}),e(he,{onClick:()=>{f({to:r.sender===g?r.to:r.sender,subject:`Re: ${r.subject}`})}})]})})]})}function Le(){const{Email:M,Mails:a,ShowNewMail:c}=i.useContext(k),[h]=M,[L,p]=a,[g,r]=c,o=i.useRef(null),[f,S]=i.useState(!1),[t,I]=i.useState({to:"",subject:"",message:"",attachments:[]});i.useEffect(()=>{typeof g=="object"&&I({...t,to:g.to,subject:g.subject})},[g]);const v=()=>{f&&(t.to===""||t.subject===""||t.message===""||N("Mail",{action:"sendMail",data:t},Math.random().toString(36).substring(7)).then(u=>{if(!u)return;let d={...t,id:u,read:!0,sender:h,timestamp:Date.now()};if(p([d,...L]),P.APPS.MAIL.recentmails.value){let m=P.APPS.MAIL.recentmails.value;m.length>=10&&m.pop(),m.unshift(d),P.APPS.MAIL.recentmails.set(m)}r(!1)}))};return i.useEffect(()=>{const u=t.to.match(/^([\w.%+-]+)@([\w-]+\.)+([\w]{2,})$/i);t.to!==""&&u&&t.subject!==""&&t.message!==""&&h!==t.to?S(!0):S(!1)},[t]),s(F.div,{className:"new-mail-container",initial:{opacity:0,y:"100%"},animate:{opacity:1,y:0},exit:{opacity:0,y:"100%"},transition:{duration:.3,ease:"easeInOut"},children:[s("div",{className:"new-mail-header",children:[e("div",{className:"cancel",onClick:()=>r(!1),children:n("APPS.MAIL.CANCEL")}),e("div",{className:"title",children:n("APPS.MAIL.NEW_MESSAGE")}),e("div",{className:"send","data-disabled":!f,onClick:()=>v(),children:n("APPS.MAIL.SEND")})]}),s("div",{className:"mail-options",children:[s("div",{className:"option",children:[s("div",{className:"title",children:[n("APPS.MAIL.TO"),":"]}),e(y,{className:"blue",maxLength:60,defaultValue:t.to,onChange:u=>{I({...t,to:u.target.value})}})]}),s("div",{className:"option",children:[s("div",{className:"title",children:[n("APPS.MAIL.FROM"),":"]}),e(y,{type:"text",value:h,disabled:!0})]}),s("div",{className:"option",children:[s("div",{className:"title",children:[n("APPS.MAIL.SUBJECT"),":"]}),e(y,{type:"text",maxLength:50,defaultValue:t.subject,onChange:u=>{I({...t,subject:u.target.value})}})]}),s("div",{className:"option textarea",children:[s("div",{className:"title",children:[n("APPS.MAIL.MESSAGE"),":"]}),e(ge,{ref:o,onChange:u=>{o.current.style.height="auto",o.current.style.height=o.current.scrollHeight+"px",I({...t,message:u.target.value})}}),e("div",{className:"attachments",children:t.attachments.map((u,d)=>s("div",{className:"attachment",children:[e("img",{src:u,onClick:()=>{x.FullscreenImage.set(u)}},d),e(fe,{onClick:m=>{m.stopPropagation();const A=t.attachments;A.splice(d,1),I({...t,attachments:A})}})]},d))})]})]}),e("div",{className:"mail-footer",children:e("div",{className:"footer-wrapper",children:e(Ae,{onClick:()=>{var u,d,m;x.Gallery.set({allowExternal:(m=(d=(u=j)==null?void 0:u.value)==null?void 0:d.AllowExternal)==null?void 0:m.Mail,onSelect:A=>I({...t,attachments:[...t.attachments,A.src]})})}})})})]})}function Ee(){const{Email:M,View:a}=i.useContext(k);V(j);const[c,h]=M,[L,p]=a,[g,r]=i.useState(null),[o,f]=i.useState({email:"",password:""}),S=()=>{r(null),N("Mail",{action:"login",data:o},{success:!0}).then(t=>{t&&t.success?(h(o.email),P.APPS.MAIL.address.set(o.email),P.APPS.MAIL.recentmails.set(null),p("home")):t&&t.reason&&(C("warning",t),r(t.reason))})};return s("div",{className:"mail-form",children:[s("div",{className:"item",children:[e("div",{className:"title",children:n("APPS.MAIL.EMAIL")}),e("div",{className:"input",children:e(y,{type:"text",placeholder:`mail@${j.value.EmailDomain}`,maxLength:50,onChange:t=>{f({...o,email:t.target.value})}})})]}),s("div",{className:"item",children:[e("div",{className:"title",children:n("APPS.MAIL.PASSWORD")}),e("div",{className:"input",children:e(y,{type:"password",placeholder:"********",onChange:t=>{f({...o,password:t.target.value})}})}),g==="Incorrect address / password"&&e("div",{className:"error",children:n("APPS.MAIL.EMAIL_OR_PASS_INVALID")})]}),e("div",{className:"button",onClick:()=>S(),children:n("APPS.MAIL.LOGIN")}),s("div",{className:"footer",children:[n("APPS.MAIL.NO_EMAIL")," ",e("span",{onClick:()=>p("signup"),children:n("APPS.MAIL.CREATE_ONE")})]})]})}function be(){var I;const{Email:M,View:a}=i.useContext(k),[c,h]=M,[L,p]=a,g=V(j),[r,o]=i.useState(null),[f,S]=i.useState({email:"",password:""}),t=()=>{if(f.email===""||f.password==="")return C("warning","Email or password is empty");N("Mail",{action:"createMail",data:f},{success:!0}).then(v=>{if(v&&v.success){const u=`${f.email}@${g.EmailDomain}`;h(u),p("home"),P.APPS.MAIL.address.set(u)}else if(v&&v.reason)return o(v.reason)})};return s("div",{className:"mail-form",children:[s("div",{className:"item",children:[e("div",{className:"title",children:n("APPS.MAIL.EMAIL")}),s("div",{className:"input",children:[e(y,{type:"text",placeholder:"email",maxLength:50-((I=g.EmailDomain)==null?void 0:I.length),onChange:v=>{v.target.value.match(/^[a-zA-Z0-9._-]+$/)&&S({...f,email:v.target.value})}}),s("div",{className:"suffix",children:["@",g.EmailDomain]})]}),r==="Address already exists"&&e("div",{className:"error",children:n("APPS.MAIL.EMAIL_EXISTS")})]}),s("div",{className:"item",children:[e("div",{className:"title",children:n("APPS.MAIL.PASSWORD")}),e("div",{className:"input",children:e(y,{type:"password",placeholder:"********",onChange:v=>{S({...f,password:v.target.value})}})})]}),e("div",{className:"button",onClick:()=>t(),children:n("APPS.MAIL.CREATE_MAIL")}),s("div",{className:"footer",children:[n("APPS.MAIL.ALREADY_HAVE")," ",e("span",{onClick:()=>p("login"),children:n("APPS.MAIL.LOGIN")})]})]})}const Ce={home:e(Ne,{}),mail:e(Ie,{}),signup:e(be,{}),login:e(Ee,{})},k=i.createContext(null);function Oe(){const[M,a]=i.useState(null),[c,h]=i.useState("signup"),[L,p]=i.useState([]),[g,r]=i.useState(null),[o,f]=i.useState(!1),[S,t]=i.useState(!1),[I,v]=i.useState(!0),u=d=>{if(d){if(pe()){r(d),h("mail");return}N("Mail",{action:"getMail",id:d.id}).then(m=>{if(!m)return;r(m),h("mail");let A=P.APPS.MAIL.recentmails.value;A=A==null?void 0:A.map(O=>(O.id===d.id&&(O.read=!0),O)),P.APPS.MAIL.recentmails.set(A)})}};return i.useEffect(()=>{if(P.APPS.MAIL.address.value){console.log(P.APPS.MAIL.address.value),a(P.APPS.MAIL.address.value),v(!1),h("home");return}N("Mail",{action:"isLoggedIn"},"demo@lbscripts.com").then(d=>{d&&(a(d),h("home")),v(!1),P.APPS.MAIL.address.set(d)})},[]),ve("mail:logout",d=>{if(!d)return C("warning","No email provided to logout");if(!S)return C("info","User is not logged in, cannot log out");if(d!==M)return C("warning","Email provided does not match current email, not logging out");a(null),t(!1),h("login")}),e("div",{className:"mail-container",children:s(k.Provider,{value:{Email:[M,a],View:[c,h],Mails:[L,p],SelectedMail:[g,r],ShowNewMail:[o,f],LoggedIn:[S,t],fetchAndSetMail:u},children:[e(Pe,{initial:!1,mode:"wait",children:o&&e(Le,{})}),Ce[c]]})})}export{k as MailContext,Oe as default};
