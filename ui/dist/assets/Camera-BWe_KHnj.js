var me=Object.defineProperty;var Te=(e,t,a)=>t in e?me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var v=(e,t,a)=>Te(e,typeof t!="symbol"?t+"":t,a);import{u as M,r as d,ai as ve,J as T,n as Ee,k as p,aj as ae,ak as pe,al as Re,S as Ae,i as $,am as Y,a1 as L,j as h,F as xe,a as D,an as _e,L as re,ag as we,o as q,ao as ge,ap as be,P as ne,aq as Se,h as Fe,ar as Pe}from"./index-BmPcK3sZ.js";import{l as ye,s as Ue,f as Ce,g as De,r as Be}from"./voiceListener-DaBp0ciI.js";const Ie=`precision mediump float;

varying highp vec2 texture_coords;

uniform sampler2D external_texture;
uniform sampler2D u_prev_frame_texture[4];

void main()
{
    vec4 color = texture2D(external_texture, texture_coords);
    if (color.rgb != vec3(0.0, 0.0, 0.0)) {
        gl_FragColor = color;
        return;
    }

    for (int i = 0; i < 4; i++) {
        vec4 prev_color = texture2D(u_prev_frame_texture[i], texture_coords);
        if (prev_color.rgb != vec3(0.0, 0.0, 0.0)) {
            gl_FragColor = prev_color;
            break;
        }
    }

    // if (!foundColor) {
    //     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
    // }
}`,Me=`attribute vec2 a_position;
attribute vec2 a_texcoord;

varying vec2 texture_coords;

void main() {
	gl_Position = vec4(a_position, 0.0, 1.0);

	texture_coords = a_texcoord;
}`;function ie(e,t,a){const r=e.createShader(t);if(!r)throw new Error("Could not create shader");return e.shaderSource(r,a),e.compileShader(r),r}function Ne(e,t){let a;a=e.createTexture(),e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([255,0,0,255])),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.MIRRORED_REPEAT),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);let r=[];for(let i=0;i<t;i++){let s=e.createTexture();s&&(e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.canvas.width,e.canvas.height,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array(e.canvas.width*e.canvas.height*4)),r.push(s))}return{mainTexture:a,prevTextures:r}}function Xe(e,t){let a,r;a=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),e.STATIC_DRAW),r=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),e.STATIC_DRAW);let i=[];for(const s of t){let f=e.createFramebuffer();f&&(e.bindFramebuffer(e.FRAMEBUFFER,f),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),i.push(f))}return e.bindFramebuffer(e.FRAMEBUFFER,null),{vertexBuffer:a,texcoordBuffer:r,prevBuffers:i}}function Oe(e){const t=ie(e,e.VERTEX_SHADER,Me),a=ie(e,e.FRAGMENT_SHADER,Ie),r=e.createProgram();if(!r)throw new Error("Could not create program");e.attachShader(r,t),e.attachShader(r,a),e.linkProgram(r),e.useProgram(r);const i=e.getAttribLocation(r,"a_position"),s=e.getAttribLocation(r,"a_texcoord");return{program:r,vloc:i,tloc:s}}class Le{constructor(t){v(this,"quality",1);v(this,"xOffset",0);v(this,"yOffset",0);v(this,"gl",null);v(this,"program",null);v(this,"viewport",{x:0,y:0,width:0,height:0});v(this,"canvasSize",{width:0,height:0});v(this,"animationFrame",null);v(this,"mainTexture",null);v(this,"hasPrevFrame",!1);v(this,"prevTextures",[]);v(this,"prevBuffers",[]);v(this,"render",()=>{const{gl:t,program:a,mainTexture:r,prevTextures:i,prevBuffers:s,viewport:f}=this;if(!(!t||!a||!r||!i)){{t.viewport(f.x,0,f.width,f.height),t.bindFramebuffer(t.FRAMEBUFFER,null),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,r);for(let l=0;l<i.length;l++)t.activeTexture(t.TEXTURE1+l),t.bindTexture(t.TEXTURE_2D,i[l]);t.drawArrays(t.TRIANGLE_STRIP,0,4)}t.viewport(0,0,window.innerWidth,window.innerHeight);for(let l=i.length-1;l>=0;l--)t.bindFramebuffer(t.FRAMEBUFFER,s[l]),t.activeTexture(t.TEXTURE1+l),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,r),t.drawArrays(t.TRIANGLE_STRIP,0,4);t.finish(),this.animationFrame=requestAnimationFrame(this.render)}});if(!t)throw new Error("No canvas");const a=t.getContext("webgl",{antialias:!1,depth:!1,alpha:!1,stencil:!1,desynchronized:!1,preserveDrawingBuffer:!0,powerPreference:"high-performance"});if(!a)throw new Error("Could not get WebGL context");this.gl=a;const{program:r,vloc:i,tloc:s}=Oe(a);let f=4;const{mainTexture:l,prevTextures:E}=Ne(a,f);this.mainTexture=l,this.prevTextures=E;const{vertexBuffer:_,texcoordBuffer:R,prevBuffers:A}=Xe(a,E);this.program=r,a.uniform1i(a.getUniformLocation(r,"external_texture"),0);for(let w=0;w<E.length;w++)a.uniform1i(a.getUniformLocation(r,"u_prev_frame_texture["+w+"]"),w+1);a.bindBuffer(a.ARRAY_BUFFER,_),a.vertexAttribPointer(i,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(i),a.bindBuffer(a.ARRAY_BUFFER,R),a.vertexAttribPointer(s,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(s),this.prevBuffers=A,this.resize(window.innerWidth,window.innerHeight),requestAnimationFrame(this.render)}resize(t,a){const{gl:r}=this;if(!r)return;const i=window.innerWidth,s=window.innerHeight,f=Math.min(i/t,s/a),l=t*f,E=a*f,_=(l-i)/2,R=(E-s)/2;r.canvas.width=i,r.canvas.height=s,this.viewport={x:_,y:R,width:i,height:s},r.viewport(_,R,i,s),r.canvas.width=t,r.canvas.height=a,this.canvasSize={width:t,height:a};for(const A of this.prevTextures)r.bindTexture(r.TEXTURE_2D,A),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,i,s,0,r.RGBA,r.UNSIGNED_BYTE,new Uint8Array(i*s*4));this.applyQuality(),this.applyOffset()}resizeByAspect(t){const a=window.innerWidth,r=window.innerHeight;let i=r*t,s=a/t;i>a?i=a:s=r,this.resize(i,s)}setQuality(t){const{canvasSize:a}=this;this.quality=t,this.resize(a.width,a.height)}setXOffset(t){const{canvasSize:a}=this;this.xOffset=-t,this.resize(a.width,a.height)}setYOffset(t){const{canvasSize:a}=this;this.yOffset=t,this.resize(a.width,a.height)}applyQuality(){const{gl:t,quality:a,viewport:r,canvasSize:i}=this;if(!t)return;const s=r.x*a,f=r.y*a,l=r.width*a,E=r.height*a;t.viewport(s,f,l,E),t.canvas.width=i.width*a,t.canvas.height=i.height*a}applyOffset(){const{gl:t,xOffset:a,yOffset:r}=this;if(!t)return;const i=window.innerWidth,s=window.innerHeight,[f,l,E,_]=t.getParameter(t.VIEWPORT),R=f*2+i,A=l*2+s,w=f+(i-R)*a,g=l+(s-A)*r;this.viewport={x:w,y:g,width:E,height:_},t.viewport(w,g,E,_)}destroy(t=!1){var a,r;this.animationFrame&&cancelAnimationFrame(this.animationFrame),!t&&((a=this.gl)!=null&&a.canvas)&&"remove"in this.gl.canvas&&this.gl.canvas.remove(),this.gl&&((r=this.gl.getExtension("WEBGL_lose_context"))==null||r.loseContext(),this.gl=null)}pause(){this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}resume(){this.animationFrame||(this.animationFrame=requestAnimationFrame(this.render))}}function We(){var Z;const e=M(Fe),[t,a]=d.useState(!1),[r,i]=d.useState("Photo"),[s,f]=d.useState(!1),[l,E]=d.useState(!1),[_,R]=d.useState(!1),[A,w]=d.useState(!1),[g,j]=d.useState(!1),[se,Q]=d.useState(0);d.useState({});const k=d.useRef(null),z=d.useRef(null),S=d.useRef(null),J=M(Y.Visible),G=M(Y.Unlocked),y=d.useRef(null),F=d.useRef(null),x=["Video","Photo"],U=M(Pe),C=M(ne),B=d.useRef(!1),{playSound:oe}=ve(),ce=()=>{if(p("Camera",{action:B.current?"open":"close"}),y.current&&y.current.resume(),F.current||De("Camera").then(n=>{n&&(F.current=n)}),p("Camera",{action:"flipCamera",value:A}),L.APPS.CAMERA.lastImage.value)return X(L.APPS.CAMERA.lastImage.value);p("Camera",{action:"getLastPhoto"}).then(n=>{n&&X(n)})},ue=()=>{p("Camera",{action:"close"}),g&&j(!1),y.current&&y.current.pause(),F.current&&(Be("Camera"),F.current=null)};d.useEffect(()=>{var o;const n=!(U!=null&&U.visible)&&((o=C==null?void 0:C.active)==null?void 0:o.name)==="Camera"&&J&&G;B.current!==n&&(B.current=n,T("info","Camera app active:",n),n?ce():ue())},[U==null?void 0:U.visible,(Z=C==null?void 0:C.active)==null?void 0:Z.name,J,G]),Ee("camera:usedCommand",n=>{if(!B.current)return T("info","camera:usedCommand - camera app is not active");switch(T("info","camera:usedCommand",n),n){case"takePhoto":N();break;case"toggleFlash":f(o=>!o);break;case"leftMode":i(o=>x.indexOf(o)===0?x[x.length-1]:x[x.indexOf(o)-1]);break;case"rightMode":i(o=>x.indexOf(o)===x.length-1?x[0]:x[x.indexOf(o)+1]);break;case"toggleFlip":w(o=>!o);break}});const le=n=>{let o=(n%60).toString().padStart(2,"0"),c=(Math.floor(n/60)%60).toString().padStart(2,"0");return Math.floor(n/3600).toString().padStart(2,"0")+":"+c+":"+o};d.useEffect(()=>{if(!S.current||y.current)return;let n=new Le(S.current);n.resizeByAspect(4/3),y.current=n},[S.current]),d.useEffect(()=>{if(!B.current)return T("info","camera app is not active, not triggering flipCamera");p("Camera",{action:"flipCamera",value:A})},[A]),d.useEffect(()=>{if(!z.current)return;let n=[];const c=setInterval(()=>{n.length>2&&(n=[]),n.push("."),z.current.innerText=re("APPS.CAMERA.UPLOADING")+n.join("")},500);return()=>clearInterval(c)},[t]),d.useEffect(()=>{if(!g||!S.current)return;const o=S.current.captureStream(e.Video.FrameRate??24),c=new AudioContext,u=new MediaStreamAudioDestinationNode(c);F.current?c.createMediaStreamSource(F.current).connect(u):c.createOscillator().connect(u),ye("Camera",c,u);const P=[o.getTracks()[0]];(F.current||e.RecordNearbyVoices)&&P.push(u.stream.getAudioTracks()[0]);const fe=new MediaStream(P),b=new MediaRecorder(fe,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:e.Video.Bitrate*8*1e3});let W=0,ee=[];const de=b.audioBitsPerSecond+b.videoBitsPerSecond,te=setInterval(()=>{const m=(Date.now()-W)/1e3,V=de*m/8/1024/1024,O=ae(V,2);O>=e.Video.MaxSize&&(T("info",`Video file size limit reached (${O}mb)`),clearInterval(te),N())},100);b.ondataavailable=m=>{var I;((I=m==null?void 0:m.data)==null?void 0:I.size)>0&&ee.push(m.data)},b.onerror=m=>{T("error","error recording:",m)},b.onstop=async()=>{a(!0),clearInterval(te);const m=Date.now()-W,I=new Blob(ee,{type:"video/webm"});c.close(),Ue("Camera");const V=await Ce(I,m,{logger:!1});a(!1);try{await K(V,!0),a(!1)}catch(O){a(!1),R(O.message),await new Promise(he=>setTimeout(he,7500)),R(!1)}},W=Date.now(),b.start();const H=setInterval(()=>{Q(m=>m>=e.Video.MaxDuration?(clearInterval(H),T("info","Max duration reached, stopping recording"),N(),0):m+1)},1e3);return()=>{Q(0),H&&clearInterval(H),b.state==="recording"&&b.stop(),s&&p("toggleFlashlight",!1),p("Camera",{action:"toggleHud",hide:!1}),T("info","stopped recording")}},[g]);async function K(n,o){const c=ae(n.size/1e3,2),u=await pe(o?"Video":"Image",n);return o?X(URL.createObjectURL(n),!0):X(u),T("info",`Saving ${o?"video":"photo"} to gallery (${c}kb) - ${u}, args(${u}, ${c}, ${A&&!o?"selfie":null})`),await Re(u,c,A&&!o?"selfie":null,!0),!0}async function N(){var o,c;if(l)return T("info","Already taking photo");if(t)return T("info","Already uploading");if(await p("Camera",{action:"toggleHud",hide:!0}),r==="Video"){!g&&s&&await p("toggleFlashlight",!0),j(u=>!u),T("info","Type is video");return}s&&await p("toggleFlashlight",!0),E(!0),a(!0),(c=(o=Ae.value)==null?void 0:o.sound)!=null&&c.silent||oe({url:"./assets/sound/other/cameraShutter.mp3"}),$.IndicatorVisible.set(!1),T("info","Uploading image, converting to blob");const n=await new Promise(u=>{S.current.toBlob(u,e.Image.Mime,e.Image.Quality)});s&&p("toggleFlashlight",!1).then(()=>Y.Flashlight.set(!1)),p("Camera",{action:"toggleHud",hide:!1});try{await K(n,!1),a(!1),T("info","Uploaded"),$.IndicatorVisible.set(!0)}catch(u){a(!1),R(u.message),T("warning","Failed upload"),$.IndicatorVisible.set(!0),await new Promise(P=>setTimeout(P,7500)),R(!1)}E(!1)}const X=(n,o)=>{if(o===void 0&&(o=Se(n)!==null),o){const c=document.createElement("video");c.src=n,c.muted=!0,c.play();const u=document.createElement("canvas");if(!u)return;c.addEventListener("loadeddata",()=>{u.width=c.videoWidth,u.height=c.videoHeight,u.getContext("2d").drawImage(c,0,0,u.width,u.height);const P=u.toDataURL("image/png");k.current.style.backgroundImage=`url(${P})`,L.APPS.CAMERA.lastImage.set(P),u.remove(),c.remove()})}else k.current.style.backgroundImage=`url(${n})`,L.APPS.CAMERA.lastImage.set(n)};return h(xe,{children:D("div",{className:"camera-container",children:[h("canvas",{ref:S,style:{visibility:l?"hidden":"visible"}}),t&&D("div",{className:"loading",children:[h(_e,{size:80,speed:1,color:"#ffffff"}),h("div",{className:"uploading",ref:z,children:re("APPS.CAMERA.UPLOADING")})]}),_&&h("div",{className:"loading",children:D("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-tablet/server/apiKeys.lua",h("br",{}),h("br",{}),_]})}),D("div",{className:"absolute-elements",children:[h(we,{children:r==="Video"&&h(q.div,{className:"timer",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15,ease:"easeInOut"},children:le(se)},"timer")}),D("div",{className:"right-panel",children:[D("div",{className:"buttons",children:[h(q.button,{whileTap:{scale:.9},className:"button","data-active":s,onClick:()=>f(n=>!n),children:h(ge,{})}),h(q.button,{whileTap:{scale:.9},className:"button",onClick:()=>w(n=>!n),children:h(be,{})})]}),h("div",{className:"camera-button",onClick:N,children:h("div",{className:"camera-button-container",children:h("div",{className:`camera-button-inner ${r=="Video"&&`${r} ${g==!0&&"Recording"}`}`})})}),h("div",{className:"image-gallery",ref:k,onClick:()=>{G&&(p("Camera",{action:"close"}),ne.patch({active:{name:"Photos"}}))}}),h("div",{className:"actions",children:x.map((n,o)=>h("div",{className:"action","data-active":r===n,onClick:()=>i(n),children:n},o))})]})]})]})})}export{We as default};
