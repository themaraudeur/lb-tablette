var q=Object.defineProperty;var _=o=>{throw TypeError(o)};var z=(o,e,i)=>e in o?q(o,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[e]=i;var I=(o,e,i)=>z(o,typeof e!="symbol"?e+"":e,i),B=(o,e,i)=>e.has(o)||_("Cannot "+i);var $=(o,e,i)=>(B(o,e,"read from private field"),i?i.call(o):e.get(o)),W=(o,e,i)=>e.has(o)?_("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(o):e.set(o,i),j=(o,e,i,c)=>(B(o,e,"write to private field"),c?c.call(o,i):e.set(o,i),i);import{J as g,u as R,r as u,W as L,a1 as b,k as T,i as F,L as S,ak as X,a as O,j as n,c as Z,K as ee,o as U,p as te,O as J,I as G,aa as H,F as ie,ag as ae,a7 as oe,aS as re,aT as se,aO as ne,aU as ce,a6 as le,a8 as de,S as ue,ar as me,P as he,aj as fe}from"./index-BmPcK3sZ.js";import{g as pe,l as ve,r as ge,s as Pe,f as Ee}from"./voiceListener-DaBp0ciI.js";const Me={voiceMemos:{tablet:[{id:1,title:"Job Interview",timestamp:Date.now()-1e3*60*60*60,duration:60*5,src:"https://loaf-scripts.com/fivem/lb-phone/mockdata/test.mp3"},{id:2,title:"Breze - Interrogation (351K)",timestamp:Date.now()-1e3*60*60*5,duration:60*12,src:"https://loaf-scripts.com/fivem/lb-phone/mockdata/interrogation.mp3"}],phone:[{id:3,title:"Voice Memo 1",timestamp:Date.now()-1e3*60*60*2,duration:1,src:"https://loaf-scripts.com/fivem/lb-phone/mockdata/one.mp3"},{id:4,title:"Birds Chirping",timestamp:Date.now()-1e3*60*60*5,duration:22,src:"https://loaf-scripts.com/fivem/lb-phone/mockdata/birds-chirping.mp3"}]}},K=async(o,e=25,i=7,c=360,r=120,h)=>{let A=new AudioContext,s=document.createElement("canvas");s.width=c,s.height=r;const m=await A.decodeAudioData(await o.arrayBuffer());let P=(s.width-(e-1)*i)/e,N=s.height/2,a=0,d=Math.floor((m.length-a)/e),l=m.getChannelData(0),E=s.getContext("2d");E.fillStyle="#000";for(let C=0;C<e;C++){let w=1,y=.001;for(let t=0;t<d;t++){let p=l[a+C*d+t]*15;p<w&&(w=p),p>y&&(y=p)}let x=Math.min(Math.max(6,(y-w)*N),s.height),V=N-x/2;E.beginPath(),E.roundRect(C*(P+i),V,P,x,5),E.fill()}const f=await new Promise(C=>s.toBlob(C)),M=s.toDataURL();return s.remove(),{blob:f,base64:M}},Ce=async(o,e=.01)=>{const i=new AudioContext,c=await o.arrayBuffer(),A=(await i.decodeAudioData(c)).getChannelData(0).every(s=>Math.abs(s)<e);return i.close(),A};var k;class Oe{constructor(){W(this,k);I(this,"audioCtx");I(this,"recorder");I(this,"destination");I(this,"chunks");I(this,"stream");I(this,"start",async(e,i)=>{if(!this.stream){const r=await pe("AudioRecorder");if(!r)return g("error","AudioRecorder: Failed to get audio stream");this.stream=r}this.recorder&&(this.recorder.state!=="inactive"&&this.recorder.stop(),this.recorder=null,this.chunks=[]),this.audioCtx&&this.audioCtx.close(),this.audioCtx=new AudioContext,this.destination=new MediaStreamAudioDestinationNode(this.audioCtx),this.audioCtx.createMediaStreamSource(this.stream).connect(this.destination),ve("AudioRecorder",this.audioCtx,this.destination),this.recorder=new MediaRecorder(this.destination.stream),this.recorder.ondataavailable=r=>{this.chunks.push(r.data),i&&i(this.chunks)},j(this,k,Date.now()),this.chunks=[],this.recorder.start(e)});I(this,"stop",async()=>{const{recorder:e,chunks:i}=this;if(this.stream&&ge("AudioRecorder"),Pe("AudioRecorder"),!e||e.state==="inactive")return g("error","AudioRecorder: Failed to end recording: not recording"),!1;const c=await new Promise(P=>{e.onstop=()=>{P(Date.now()-$(this,k))},e.stop()}),r=await Ee(new Blob(i,{type:e.mimeType}),c,{logger:!1});if(this.audioCtx&&this.audioCtx.close(),this.stream=null,this.audioCtx=null,this.recorder=null,this.chunks=[],await Ce(r))return g("info","AudioRecorder: Audio file is quiet. Returning false"),!1;const h=await K(r),A=await K(r,60,7,960,200),s=new Audio;s.src=URL.createObjectURL(r);let m={blob:r};return m.waveform={message:h.blob,placeholder:A.base64},s.duration!==1/0&&!isNaN(s.duration)?{...m,duration:Math.round(s.duration)}:(s.currentTime=Number.MAX_SAFE_INTEGER,await new Promise(P=>{g("info","AudioRecorder: Waiting for audio duration"),s.ontimeupdate=()=>{URL.revokeObjectURL(s.src),g("info","AudioRecorder: Got audio duration, revoked URL"),P({...m,duration:Math.round(s.duration)})}}))});this.recorder=null,this.chunks=[]}}k=new WeakMap;const Y=J(null),D=J([]);function be(){const o=R(D),e=R(de);u.useRef(null);const i=u.useRef(null),[c,r]=u.useState("tablet"),[h,A]=u.useState(""),[s,m]=u.useState(!1);u.useEffect(()=>{if(L("VoiceMemo")){if(i.current=new Oe,b.APPS.VOICEMEMO.voicememos.value&&b.APPS.VOICEMEMO.voicememos.value.length>0&&c==="tablet"){g("info","Using cached voicememos, not fetching",b.APPS.VOICEMEMO.voicememos.value),D.set(b.APPS.VOICEMEMO.voicememos.value);return}return T("VoiceMemo",{action:"get"},Me.voiceMemos[c],c==="phone").then(a=>{if(!a)return g("warning","Failed to fetch voicememos, server returned false");g("info","Fetched voicememos",a),D.set(a),c==="tablet"&&b.APPS.VOICEMEMO.voicememos.set(a)}),()=>{var a;(a=i.current)!=null&&a.stream&&i.current.stop()}}},[c]);const P=()=>{let a=S("APPS.VOICEMEMO.DEFAULT_NAME"),d=o.map(l=>{let E=l.title;if(E.startsWith(a)){let f=E.split(" ");if(f.length>1&&/^\d+$/.test(f[f.length-1]))return parseInt(f[f.length-1])}return null}).filter(l=>l!==null).sort((l,E)=>l-E);if(d.length===0)return o.some(l=>l.title===a)?a+" 2":a;for(let l=0;l<d.length;l++)if(d[l]!==l+2)return a+" "+(l+2);return a+" "+(d[d.length-1]+1)},N=async a=>{};return u.useEffect(()=>{if(!s||!i.current)return;const a=i.current;return r("tablet"),a.start(100,N),()=>{a.stop().then(async d=>{if(!d){F.PopUp.set({title:S("APPS.VOICEMEMO.EMPTY_RECORDING_POPUP.TITLE"),description:S("APPS.VOICEMEMO.EMPTY_RECORDING_POPUP.DESCRIPTION"),buttons:[{title:S("APPS.VOICEMEMO.EMPTY_RECORDING_POPUP.OK")}]});return}let l;try{l=await X("Audio",d.blob)}catch(C){g("error","Failed to upload voice memo",C);return}const E=P(),f=await T("VoiceMemo",{action:"upload",data:{src:l,duration:d.duration,title:E}},Math.floor(Math.random()*100).toString());if(!f)return;let M={id:f,title:E,timestamp:new Date().getTime(),duration:d.duration,src:l};D.set([M,...o]),b.APPS.VOICEMEMO.voicememos.set([M,...o]),g("info",`Saved voice memo ${f}`)})}},[s]),O("div",{className:"voicememo-container",children:[O("div",{className:"voicememo-wrapper",children:[O("div",{className:"voicememo-header",children:[n("div",{className:"title",children:S("APPS.VOICEMEMO.VOICE_RECORDINGS")}),e&&n("div",{className:"selector",children:["tablet","phone"].map((a,d)=>n("div",{onClick:()=>r(a),className:"option","data-active":c===a,children:Z(a)},d))})]}),n(ee,{placeholder:S("APPS.VOICEMEMO.SEARCH_RECORDINGS"),onChange:a=>A(a.target.value)}),n(U.div,{...te(c==="tablet"?"left":"right",c,.2),className:"voicememo-items",children:o.filter(a=>a.title.toLowerCase().includes(h.toLowerCase())).sort((a,d)=>d.timestamp-a.timestamp).map(a=>n(Ae,{data:a},a.id))})]}),n("div",{className:"voicememo-footer",children:n("div",{className:"button-record",onClick:()=>m(!s),children:n("div",{className:"button-inner","data-recording":s})})})]})}const Ae=o=>{const{data:e}=o,i=R(ue),c=R(D),r=u.useRef(null),[h,A]=u.useState(!1),[s,m]=u.useState(!1),[P,N]=u.useState(0),a=R(Y),[d,l]=u.useState(e.title),[E,f]=u.useState(!1),[M,C]=u.useState(null),w=R(me),y=R(he);u.useEffect(()=>(r.current=new Audio(e.src),r.current.src=e.src,r.current.volume=i.sound.volume??.5,r.current.addEventListener("ended",()=>{m(!1)}),r.current.addEventListener("timeupdate",()=>{N(r.current.currentTime)}),()=>{var t,p;(t=r.current)==null||t.pause(),(p=r.current)==null||p.remove(),r.current=null}),[]),u.useEffect(()=>{var t;(w!=null&&w.visible||!L("VoiceMemo"))&&((t=r.current)==null||t.pause(),m(!1))},[w==null?void 0:w.visible,y==null?void 0:y.active]),u.useEffect(()=>{var t;a&&a!==e.id&&((t=r.current)==null||t.pause(),m(!1),A(!1))},[a]),u.useEffect(()=>{i.sound.volume&&(r.current.volume=i.sound.volume)},[i.sound.volume]),u.useEffect(()=>{m(!1),N(0),h&&Y.set(e.id)},[h]);const x=t=>{const p=Math.floor(t/60),v=fe(t-p*60,0);return`${p}:${v<10?"0"+v:v}`},V={light:{active:"#333333",slider:"#cccccc"},dark:{active:"#FFFFFF",slider:"#999999"}};return O(U.div,{className:"voicememo-item",initial:{opacity:0,scale:.9},whileInView:{opacity:1,scale:1},viewport:{once:!0},onClick:()=>A(!h),"data-expanded":h,children:[h?n(G,{className:"voicememo-title",defaultValue:d,onClick:t=>t.stopPropagation(),onLoad:t=>{t.target.style.width=t.target.value.length+"ch"},onChange:t=>{l(t.target.value),t.target.style.width=t.target.value.length+"ch"},onBlur:t=>{T("VoiceMemo",{action:"rename",id:e.id,title:t.target.value},!0).then(p=>{if(!p)return g("warning","Failed to rename voice memo");D.set(c.map(v=>v.id===e.id?{...v,title:t.target.value}:v)),b.APPS.VOICEMEMO.voicememos.set(c.map(v=>v.id===e.id?{...v,title:t.target.value}:v))})}}):n("div",{className:"voicememo-title",children:d}),h&&n("div",{className:"subtitle",children:H(e.timestamp)}),O("div",{className:"voicememo-info",children:[!h&&O(ie,{children:[n("div",{className:"date",children:H(e.timestamp)}),n("div",{className:"duration",children:x(e.duration)})]}),n(ae,{children:h&&O(U.div,{className:"voicememo-actions",initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},children:[O("div",{className:"voicememo-duration-slider",onClick:t=>t.stopPropagation(),children:[n(G,{type:"range",min:0,max:100,value:M||P/e.duration*100,style:{background:`linear-gradient(to right, ${V[i.display.theme].active} 0%, ${V[i.display.theme].active} ${M||P/e.duration*100}%, ${V[i.display.theme].slider} ${M||P/e.duration*100}%, ${V[i.display.theme].slider} 100%)`},onMouseDown:t=>{L("VoiceMemo")&&(t.stopPropagation(),f(!0))},onMouseUp:t=>{if(t.stopPropagation(),f(!1),M){if(!r.current)return g("warning","Audio ref is null");r.current.currentTime=e.duration/100*M,C(null)}},onChange:t=>{t.stopPropagation(),C(t.target.value)}}),O("div",{className:"duration",children:[n("div",{children:x(P)??"0:00"}),n("div",{children:x(e.duration)})]})]}),O("div",{className:"voicememo-item-footer",children:[n("div",{className:"share",children:n(oe,{onClick:t=>{t.stopPropagation(),F.Share.set({type:"voicememo",data:e})}})}),O("div",{className:"controls",children:[n(re,{className:"disabled"}),n("span",{onClick:t=>{if(t.stopPropagation(),!r.current)return g("warning","Audio ref is null");s?(r.current.pause(),m(!1)):(r.current.play(),m(!0))},children:s?n(se,{}):n(ne,{})}),n(ce,{className:"disabled"})]}),n("div",{className:"delete",children:n(le,{onClick:t=>{t.stopPropagation(),F.PopUp.set({title:S("APPS.VOICEMEMO.DELETE_POPUP.TITLE"),description:S("APPS.VOICEMEMO.DELETE_POPUP.DESCRIPTION"),buttons:[{title:S("APPS.VOICEMEMO.DELETE_POPUP.CANCEL")},{title:S("APPS.VOICEMEMO.DELETE_POPUP.PROCEED"),color:"red",cb:()=>{T("VoiceMemo",{action:"delete",id:e.id},!0).then(p=>{if(!p)return g("warning","Failed to delete voice memo");let v=c.filter(Q=>Q.id!==e.id);D.set(v),b.APPS.VOICEMEMO.voicememos.set(v)})}}]})}})})]})]})})]})]})};export{be as default};
