import{u as p,r as f,k as N,bw as j,J as s,h as D,n as O,a as c,o as b,j as u,L as a,g as G,aZ as k,K as J,bu as H,bs as q,O as F,i as M,ah as V,ay as Z,bD as Q,a1 as X}from"./index-BmPcK3sZ.js";const d=F([]),o=F([]),A=F(!1);function K(){var S;const r=p(X.APPS.AMBULANCE.permissions),x=p(d),T=p(o),[n,m]=f.useState(null),[I,C]=f.useState({x:0,y:0}),h=f.useRef(null);let g=f.useMemo(()=>T.filter(e=>!e.unit),[T]);f.useEffect(()=>{const e=l=>{if(!A.value||!h.current)return;const E=h.current.getBoundingClientRect();C({x:l.clientX-E.width/2,y:l.clientY-E.height/2})},t=()=>{A.value&&(A.set(!1),m(null))};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",t),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[]),f.useEffect(()=>{N("Ambulance",{action:"getUnits"},j.units).then(e=>{var t,l;if(!e)return s("error","Failed to get units");d.set([...((l=(t=D.value)==null?void 0:t.Ambulance)==null?void 0:l.DefaultUnits)??[],...e??[]])}),N("Ambulance",{action:"getActiveUnits"},j.activeUnits).then(e=>{if(!e)return s("error","Failed to get active units");o.set(e)})},[]),O("addUnit",e=>{if(!e)return s("error","Failed to add unit");e.job==="ambulance"&&d.set([...d.value,e])}),O("updateUnit",e=>{if(!e)return s("error","Failed to add unit");e.job==="ambulance"&&(d.set(d.value.map(t=>t.name===e.unit?{...t,status:e.status??t.status,name:e.newName??t.name}:t)),e.newName&&o.set(o.value.map(t=>t.unit===e.unit?{...t,unit:e.newName??null}:t)))}),O("removeUnit",e=>{if(!e)return s("error","Failed to remove unit");e.job==="ambulance"&&(d.set(d.value.filter(t=>t.name!==e.unit)),o.set(o.value.map(t=>t.unit===e.unit?{...t,unit:null}:t)))}),O("setUserUnit",e=>{if(!e)return s("error","Failed to add user to unit");e.job==="ambulance"&&o.set(o.value.map(t=>t.source===e.source?{...t,unit:e.unit}:t))});const R=()=>{let e="";M.PopUp.set({title:a("APPS.POLICE.UNITS.ADD_UNIT.TITLE"),description:a("APPS.POLICE.UNITS.ADD_UNIT.DESCRIPTION"),input:{placeholder:a("APPS.POLICE.UNITS.ADD_UNIT.PLACEHOLDER"),type:"text",minLength:1,maxLength:20,onChange:t=>{e=t}},buttons:[{title:a("APPS.POLICE.CANCEL"),cb:()=>{}},{title:a("APPS.POLICE.PROCEED"),cb:()=>{if(!e)return s("error","Unit name is required");if(d.value.some(t=>t.name===e))return s("error","Unit name already exists");N("Ambulance",{action:"addUnit",name:e},!0).then(t=>{if(!t)return s("error","Failed to add unit");s("info","Unit added"),V()&&d.set([...d.value,{name:e,status:"available"}])})}}]})},L=(e,t)=>{var l;if(!((l=r==null?void 0:r.unit)!=null&&l.edit))return s("error","You do not have permission to edit units");A.set(!0),m(e),C({x:t.clientX-50,y:t.clientY-25})},U=(e,t)=>{if(!n)return s("error","No employee to drag");if(t){if(o.value.some(l=>l.source===n.source&&l.unit===t))return m(null);N("Ambulance",{action:"assignOfficerToUnit",officerId:n.source,unit:t},!0).then(l=>{if(!l)return s("error","Failed to assign officer to unit");o.set(o.value.map(E=>E.source===n.source?{...E,unit:t}:E))})}else N("Ambulance",{action:"removeOfficerFromUnit",officerId:n.source},!0).then(l=>{if(!l)return s("error","Failed to remove officer from unit");o.set(o.value.map(E=>E.source===n.source?{...E,unit:null}:E))});A.set(!1),m(null)};return c(b.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{ease:"easeInOut",duration:.25},className:"policepage-container",children:[u("main",{className:"main",style:{padding:"0"},children:c("div",{className:"page",style:{gap:"0"},children:[c("div",{className:"top",children:[u("div",{className:"title",children:a("APPS.POLICE.UNITS.TITLE")}),((S=r==null?void 0:r.unit)==null?void 0:S.create)&&c("div",{className:"button",onClick:R,children:[u(G,{}),a("APPS.POLICE.UNITS.ADD_UNIT.TITLE")]})]}),c("div",{className:"units-container",children:[u("div",{className:"grid",children:x.map(e=>u(W,{unit:e,handleDragStart:L,handleDragEnd:U,draggedEmployee:n},e.name))}),c(b.div,{className:"grid-item full",onMouseUp:e=>{n&&U()},children:[u("div",{className:"top",children:c("div",{className:"title",children:[a("APPS.AMBULANCE.UNITS.AVALIABLE_EMPLOYEES"),c("div",{className:"subtitle",children:[u(k,{}),g.length]})]})}),u(J,{placeholder:a("APPS.AMBULANCE.UNITS.SEARCH_EMPLOYEES")}),c("div",{className:"items full",children:[g.map((e,t)=>c(b.div,{...H,className:q("item unit",(n==null?void 0:n.source)===e.source&&"dragging"),onMouseDown:l=>L(e,l),style:{cursor:"grab"},children:[e.callsign&&u("div",{className:"card green tabular",children:e.callsign}),u("div",{className:"name",children:e.name})]},t)),n&&u("div",{className:"drop-indicator",children:a("APPS.AMBULANCE.UNITS.DROP_EMPLOYEE_AVAILABLE")})]})]})]})]})}),A.value&&n&&u("div",{ref:h,className:"dragging-card",style:{position:"fixed",left:I.x,top:I.y},children:c("div",{className:"item unit",children:[n.callsign&&u("div",{className:"card green tabular",children:n.callsign}),u("div",{className:"name",children:n.name})]})})]})}const W=({unit:r,handleDragStart:x,handleDragEnd:T,draggedEmployee:n})=>{var L,U,S,e,t,l,E,w;const m=p(X.APPS.AMBULANCE.permissions),I=f.useMemo(()=>o.value.filter(i=>i.unit===r.name),[o.value,r.name]);let C=Z(()=>{var i;if(!A.value){if(!((i=m==null?void 0:m.unit)!=null&&i.edit))return s("error","You do not have permission to edit units");g()}}),h=(e=(S=(U=(L=D.value)==null?void 0:L.Ambulance)==null?void 0:U.UnitStatuses)==null?void 0:S[r==null?void 0:r.status])==null?void 0:e.color;const g=()=>{M.ContextMenu.set({buttons:[{title:a("APPS.POLICE.UNITS.RENAME_UNIT.TITLE"),cb:()=>{let i="";M.PopUp.set({title:a("APPS.POLICE.UNITS.RENAME_UNIT.TITLE"),description:a("APPS.POLICE.UNITS.RENAME_UNIT.DESCRIPTION"),input:{placeholder:a("APPS.POLICE.UNITS.RENAME_UNIT.PLACEHOLDER"),type:"text",minLength:1,maxLength:20,onChange:P=>{i=P}},buttons:[{title:a("APPS.POLICE.CANCEL"),cb:()=>{}},{title:a("APPS.POLICE.PROCEED"),cb:()=>{if(!i)return s("error","Unit name is required");N("Ambulance",{action:"renameUnit",unit:r.name,name:i},!0).then(P=>{if(!P)return s("error","Failed to edit unit name")})}}]})}},{title:a("APPS.POLICE.UNITS.DELETE_UNIT.TITLE"),color:"red",cb:()=>R()}]})},R=()=>{var i;if(!((i=m==null?void 0:m.unit)!=null&&i.delete))return s("error","You do not have permission to delete units");M.PopUp.set({title:a("APPS.POLICE.UNITS.DELETE_UNIT.TITLE"),description:a("APPS.POLICE.UNITS.DELETE_UNIT.DESCRIPTION"),buttons:[{title:a("APPS.POLICE.CANCEL")},{title:a("APPS.POLICE.DELETE"),color:"red",cb:()=>{N("Ambulance",{action:"deleteUnit",unit:r.name},!0).then(P=>{if(!P)return s("error","Failed to delete unit");s("info","Unit deleted"),V()&&(d.set(d.value.filter(v=>v.name!==r.name)),o.set(o.value.map(v=>v.unit===r.name?{...v,unit:null}:v)))})}}]})};return c(b.div,{...C,className:"grid-item",onMouseUp:i=>{n&&T(n,r.name)},children:[c("div",{className:"top",children:[c("div",{className:"title",children:[r.name,c("div",{className:"subtitle",children:[u(k,{}),I.length]})]}),c("div",{className:"buttons",style:{pointerEvents:"auto"},children:[u(Q,{showTitle:!0,disabled:!((t=m==null?void 0:m.unit)!=null&&t.edit),items:(w=Object.keys(((E=(l=D.value)==null?void 0:l.Ambulance)==null?void 0:E.UnitStatuses)??{}))==null?void 0:w.map(i=>{var v,B,Y;const P=(Y=(B=(v=D.value)==null?void 0:v.Ambulance)==null?void 0:B.UnitStatuses)==null?void 0:Y[i];return{title:P==null?void 0:P.label,active:i===r.status,onSelect:()=>{N("Ambulance",{action:"updateUnitStatus",unit:r.name,status:i},!0).then(z=>{if(!z)return s("error","Failed to update unit status");d.set(d.value.map(_=>_.name===r.name?{..._,status:i}:_))})}}})}),u("div",{className:"status","data-color":h})]})]}),c("div",{className:"items",children:[I.map((i,P)=>c(b.div,{...H,className:q("item unit",(n==null?void 0:n.source)===i.source&&"dragging"),onMouseDown:v=>x(i,v),style:{cursor:"grab"},children:[i.callsign&&u("div",{className:"card green tabular",children:i.callsign}),u("div",{className:"name",children:i.name})]},P)),n&&u("div",{className:"drop-indicator",children:a("APPS.AMBULANCE.UNITS.DROP_EMPLOYEE")})]})]})};export{K as default};
