import{r as C,a as g,F as te,j as e,aj as Pe,O as q,L as i,as as me,at as he,au as ve,av as fe,aw as Ae,u as R,W,a1 as O,J as f,k as M,ax as w,ay as Se,o as G,p as se,g as Oe,ag as X,az as ge,aq as j,aA as re,s as Ee,i as _,N as le,h as Q,aB as Ce,aC as ae,al as pe,aD as Te,C as K,a7 as oe,a6 as ie,aE as ce,a8 as be,P as de,ac as Z,aF as Me,aG as Ie,aH as Ne,S as ue,aI as ye}from"./index-BmPcK3sZ.js";const $=({src:t,showAdvanced:a})=>{const[s,A]=C.useState(null);return g(te,{children:[e("video",{src:t,crossOrigin:"anonymous",controls:!1,onMouseOver:I=>{a&&I.currentTarget.play()},onMouseOut:I=>{a&&I.currentTarget.pause()},muted:!0,loop:!0,onLoadedMetadata:I=>{A(I.currentTarget.duration)}}),s&&a&&e("div",{className:"video-duration",children:(I=>{const N=Math.floor(I/60),p=Pe(I-N*60,0);return`${N}:${p<10?"0"+p:p}`})(s)})]})},D=q(null),z=[{title:i("APPS.PHOTOS.VIDEOS"),id:"videos",icon:e(me,{}),count:0},{title:i("APPS.PHOTOS.SELFIES"),id:"selfies",icon:e(he,{}),count:0},{title:i("APPS.PHOTOS.SCREENSHOTS"),id:"screenshots",icon:e(ve,{}),count:0},{title:i("APPS.PHOTOS.IMPORTS"),id:"imports",icon:e(fe,{}),count:0},{title:i("APPS.PHOTOS.DUPLICATES"),id:"duplicates",icon:e(Ae,{}),count:0}];function Re(){const t=R(D),[a,s]=C.useState(!1),A=R(O.APPS.CAMERA.albums),T=R(O.APPS.CAMERA.mediaTypes),I=R(be),N=R(de),p=C.useRef(null);C.useEffect(()=>{var u,S;if(W("Photos")){if(((u=O.APPS.CAMERA.albums.value)==null?void 0:u.length)>0&&((S=O.APPS.CAMERA.mediaTypes.value)==null?void 0:S.length)>0)return f("info","Album and mediatype cache exists, returning");M("Camera",{action:"getAlbums"},{albums:w.Albums,mediaTypes:w.MediaTypes}).then(b=>{if(!b)return f("error","No data received from server");let v=(T.length>0?T:z).map(o=>{const n=b.mediaTypes[o.id+"Photos"]??0,d=b.mediaTypes[o.id+"Videos"]??0;return{...o,count:n+d,videoCount:d,photoCount:n}});O.APPS.CAMERA.albums.set(b.albums),O.APPS.CAMERA.mediaTypes.set(v)})}},[t]),C.useEffect(()=>{if(!W("Photos"))return;let u=A.find(S=>S.id==="phone");I?M("Camera",{action:"getPhoneAlbum"},{cover:w.PhonePhotos[0].src,count:w.PhonePhotos.length,photoCount:w.PhonePhotos.filter(S=>!S.isVideo).length,videoCount:w.PhonePhotos.filter(S=>S.isVideo).length}).then(S=>{if(!S)return f("error","No data received from server");S.id="phone",S.title=i("APPS.PHOTOS.FROM_MY_PHONE"),S.removable=!1,setTimeout(()=>{u?O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(b=>b.id==="phone"?S:b)):O.APPS.CAMERA.albums.set([...O.APPS.CAMERA.albums.value,S])},100)}):setTimeout(()=>{u&&O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.filter(S=>S.id!=="phone"))},100)},[N==null?void 0:N.active]),C.useEffect(()=>p!=null&&p.current?(p.current.addEventListener("wheel",u=>{u.preventDefault(),p.current.scrollLeft+=u.deltaY}),()=>{p!=null&&p.current&&(p==null||p.current.removeEventListener("wheel",u=>{u.preventDefault(),p.current.scrollLeft+=u.deltaY}))}):f("warning","Scroll container not found"),[p==null?void 0:p.current]);const L=()=>{let u="";_.PopUp.set({title:i("APPS.PHOTOS.NEW_ALBUM_POPUP.TITLE"),description:i("APPS.PHOTOS.NEW_ALBUM_POPUP.DESCRIPTION"),input:{placeholder:i("APPS.PHOTOS.NEW_ALBUM_POPUP.PLACEHOLDER"),maxCharacters:20,onChange:S=>{u=S}},buttons:[{title:i("APPS.PHOTOS.NEW_ALBUM_POPUP.CANCEL")},{title:i("APPS.PHOTOS.NEW_ALBUM_POPUP.PROCEED"),cb:()=>{M("Camera",{action:"createAlbum",title:u},{id:Math.floor(Math.random()*1e3).toString()}).then(S=>{if(!S)return f("warning","Could not create album, id not returned");if(u.length<1)return f("warning","Input is empty, cannot create album");if(u.length>20)return f("warning","Input is too long, cannot create album");let b={title:u,id:S,cover:null,count:0,photoCount:0,videoCount:0};O.APPS.CAMERA.albums.set([...A,b])})}}]})},x=u=>{if(!u)return f("warning","No album id provided, cannot remove album");_.PopUp.set({title:i("APPS.PHOTOS.REMOVE_ALBUM.TITLE",{name:u.title}),description:i("APPS.PHOTOS.REMOVE_ALBUM.DESCRIPTION",{name:u.title}),buttons:[{title:i("APPS.PHOTOS.REMOVE_ALBUM.CANCEL")},{title:i("APPS.PHOTOS.REMOVE_ALBUM.PROCEED"),color:"red",cb:()=>{M("Camera",{action:"deleteAlbum",id:u.id},!0).then(S=>{if(!S)return f("error","Could not remove album, server returned false");O.APPS.CAMERA.albums.set(A.filter(b=>b.id!==u.id))})}}]})},m=u=>u?u.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):0,F=Se(u=>{let S=u.target;for(;!S.classList.contains("album");)S=S.parentElement;let b=S.getAttribute("data-id");if(!b)return f("warning","Could not obtain album id from element");b==="favourites"||b==="recents"||b==="phone"||_.ContextMenu.set({buttons:[{title:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.TITLE"),cb:()=>{let U="";_.PopUp.set({title:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.TITLE"),description:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.DESCRIPTION"),input:{placeholder:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.PLACEHOLDER"),minCharacters:1,maxCharacters:20,onChange:v=>{U=v}},buttons:[{title:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.CANCEL")},{title:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.PROCEED"),cb:()=>{if(U.length<1)return f("warning","Input is empty, cannot rename album");f("warning","Renaming album",b,U),M("Camera",{action:"renameAlbum",id:b,title:U},!0).then(v=>{if(!v)return f("error","Could not rename album, server returned false");O.APPS.CAMERA.albums.set(A.map(o=>o.id===b?{...o,title:U}:o))})}}]})}},{title:i("APPS.PHOTOS.DELETE"),color:"red",cb:()=>x(A.find(U=>U.id===b))}]})});return e(G.div,{...se("right",t?"inAlbum":"albums"),style:{height:"100%",paddingBottom:"9rem"},children:t?e(X,{children:e(Le,{})}):g(te,{children:[g("div",{className:"albums-header",children:[g("div",{className:"top",children:[e(Oe,{onClick:L}),e("div",{className:"edit",onClick:()=>s(!a),children:a?i("APPS.PHOTOS.DONE"):i("APPS.PHOTOS.EDIT")})]}),e("div",{className:"title",children:i("APPS.PHOTOS.ALBUMS")})]}),g("div",{className:"albums-content",children:[e("div",{className:"subtitle",children:i("APPS.PHOTOS.MY_ALBUMS")}),e("div",{className:"albums-grid","data-edit":a,ref:p,style:{overflowX:A.length>8?"auto":"hidden"},children:e(X,{children:A.map((u,S)=>g(G.div,{animate:{scale:1},exit:{scale:.2},transition:{duration:.25,ease:"easeInOut"},className:"album","data-id":u.id,"data-removable":u.removable,...F,onClick:()=>{a||D.set(u)},children:[a&&u.removable!==!1&&e("div",{className:"remove",onClick:b=>{b.stopPropagation(),x(u)},children:e(ge,{})}),g("div",{className:"cover",children:[j(u.cover)?e($,{src:u.cover,showAdvanced:!1}):e("img",{src:u.cover??"https://join.travelmanagers.com.au/wp-content/uploads/2017/09/default-placeholder-300x300.png"}),u.id==="favourites"&&e(re,{})]}),g("div",{className:"text",children:[e("div",{className:"title",children:u.title}),e("div",{className:"count",children:m(u.count)})]})]},S))})})]}),e("div",{className:"divider"}),g("div",{className:"media-types",children:[e("div",{className:"subtitle",children:i("APPS.PHOTOS.MEDIA_TYPES")}),e("div",{className:"media-types-items",children:T.map((u,S)=>g("div",{className:"item",onClick:()=>{if(a)return f("info","Edit mode is enabled, cannot open media type");D.set({...u,id:null,cover:null,type:u.id})},children:[g("div",{className:"type",children:[u.icon,u.title]}),g("div",{className:"action",children:[e("div",{className:"count",children:u.count}),e(Ee,{})]})]},S))})]})]})})}const Le=()=>{var U,v;const t=R(D),a=R(V),[s,A]=C.useState([]),[T,I]=C.useState([]),[N,p]=C.useState(!1),[L,x]=C.useState(!1),[m,F]=C.useState(!1),[u,S]=C.useState(0);C.useEffect(()=>{S(0);let o=t.id==="favourites"?w.Photos.filter(n=>n.favourite):t.id==="recents"?w.Photos:t.type==="videos"?w.Photos.filter(n=>n.isVideo):t.type?w.Photos.filter(n=>n.type===t.type):w.Photos.filter(n=>n.album===t.id)?t.id==="phone"?w.PhonePhotos:w.Photos.filter(n=>n.album===t.id):[];M("Camera",{action:"getImages",filter:t.id!=="phone"?{album:t.id,type:t.type}:{perPage:30}},o,t.id==="phone").then(n=>{if(!n)return f("warning","No data was returned from getImages event");I(n.reverse()),p(n.length===0)})},[]);const b=o=>{if(L||m)return;let n=document.querySelector("#last");if(!n)return;if(T.length<30)return f("warning","Not enough photos to fetch more");if(!Z(n)){const c=document.querySelector(".library-content");c||f("warning","Could not find library content element");const h=c==null?void 0:c.scrollHeight;F(!0),M("Camera",{action:"getImages",lastId:t.id!=="phone"?T[0].id:null,page:t.id==="phone"?u+1:null,filter:t.id!=="phone"?{album:t.id,type:t.type}:{perPage:30}},null,t.id==="phone").then(E=>{E&&E.length>0?(c.style.transform=`translateY(${h}px)`,I(r=>[...E.reverse(),...r]),F(!1),requestAnimationFrame(()=>{c.style.transition="transform 0ms",c.style.transform="translateY(0)"}),E.length<30&&x(!0)):x(!0)})}};return g(G.div,{initial:{opacity:0,x:35},animate:{opacity:1,x:0},exit:{opacity:0,x:35},transition:{duration:.25,ease:"easeInOut"},children:[g("div",{className:"library-header",children:[g("div",{className:"top",children:[e("div",{className:"info",children:g("div",{className:"back",style:{color:T.length<15?"var(--tablet-color-blue)":"#ffffff"},onClick:()=>{a&&V.set(!1),D.set(null)},children:[e(le,{}),i("APPS.PHOTOS.ALBUMS")]})}),g("div",{className:"actions",style:{color:T.length<15?"var(--tablet-color-blue)":"var(--tablet-text-primary)"},children:[e("div",{className:"button",onClick:()=>V.set(!a),children:a?i("APPS.PHOTOS.DONE"):i("APPS.PHOTOS.SELECT")}),(((v=(U=Q.value)==null?void 0:U.AllowExternal)==null?void 0:v.Gallery)||t.id!=="recents"&&t.id!=="favourites")&&e("div",{className:"button round",onClick:()=>{var d,c;let o=t.id!=="recents"&&t.id!=="favourites",n=((c=(d=Q.value)==null?void 0:d.AllowExternal)==null?void 0:c.Gallery)&&t.id!=="favourites";if(!o&&!n)return f("warning","Cannot edit or import images in this album");_.ContextMenu.set({buttons:[n&&{title:i("APPS.PHOTOS.IMPORT_IMAGE_POPUP.TITLE"),cb:()=>{let h="";_.PopUp.set({title:i("APPS.PHOTOS.IMPORT_IMAGE_POPUP.TITLE"),description:i("APPS.PHOTOS.IMPORT_IMAGE_POPUP.DESCRIPTION"),input:{placeholder:i("APPS.PHOTOS.IMPORT_IMAGE_POPUP.PLACEHOLDER"),onChange:E=>{h=E}},buttons:[{title:i("APPS.PHOTOS.IMPORT_IMAGE_POPUP.CANCEL")},{title:i("APPS.PHOTOS.IMPORT_IMAGE_POPUP.PROCEED"),cb:()=>{if(h.includes("data:image"))return f("warning","Data URL not supported");if(!Ce(h)){setTimeout(()=>{_.PopUp.set({title:i("COMPONENTS.GALLERY.EXTERNAL_URL"),description:i("COMPONENTS.GALLERY.EXTERNAL_URL_BLACKLISTED"),buttons:[{title:"OK"}]}),f("warning","External URL is blacklisted")},500);return}ae(h,E=>{if(!E)return f("error","Image does not exist");pe(h,null,"import",!0).then(r=>{if(!r)return f("error","Could not save to gallery, server returned false");let l=j(h);I([{id:r,src:h,timestamp:Date.now(),type:"import",isVideo:l},...T]),t.id!=="recents"&&t.id!=="favourites"?M("Camera",{action:"addToAlbum",album:t.id,ids:[r]}).then(P=>{if(!P)return f("error","Could not add to album, server returned false");let y=t.photoCount+1,H=l?t.videoCount+1:t.videoCount;D.set({...t,photoCount:y,videoCount:H,cover:h})}):t.id==="favourites"&&M("Camera",{action:"toggleFavourites",ids:[r],favourite:!0}).then(P=>{if(!P)return f("error","Could not add to favourites, server returned false");let y=t.photoCount+1,H=l?t.videoCount+1:t.videoCount;D.set({...t,photoCount:y,videoCount:H,cover:h})}),M("Camera",{action:"getAlbums"}).then(P=>{if(!P)return f("error","No data received from server");let y=z.map(H=>{const B=P.mediaTypes[H.id+"Photos"]??0,J=P.mediaTypes[H.id+"Videos"]??0;return{...H,count:B+J,photoCount:B,videoCount:J}});O.APPS.CAMERA.albums.set(P.albums),O.APPS.CAMERA.mediaTypes.set(y)})})})}}]})}},o&&{title:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.TITLE"),cb:()=>{let h="";_.PopUp.set({title:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.TITLE"),description:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.DESCRIPTION"),input:{placeholder:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.PLACEHOLDER"),minCharacters:1,maxCharacters:20,onChange:E=>{h=E}},buttons:[{title:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.CANCEL")},{title:i("APPS.PHOTOS.RENAME_ALBUM_POPUP.PROCEED"),cb:()=>{if(h.length<1)return f("warning","Input is empty, cannot rename album");f("info","Renaming album",t.id,h),M("Camera",{action:"renameAlbum",id:t.id,title:h},!0).then(E=>{if(!E)return f("error","Could not rename album, server returned false");D.set({...t,title:h}),O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(r=>r.id===t.id?{...r,title:h}:r))})}}]})}},o&&{title:i("APPS.PHOTOS.DELETE"),color:"red",cb:()=>{_.PopUp.set({title:i("APPS.PHOTOS.REMOVE_ALBUM.TITLE",{name:t.title}),description:i("APPS.PHOTOS.REMOVE_ALBUM.DESCRIPTION",{name:t.title}),buttons:[{title:i("APPS.PHOTOS.REMOVE_ALBUM.CANCEL")},{title:i("APPS.PHOTOS.REMOVE_ALBUM.PROCEED"),color:"red",cb:()=>{M("Camera",{action:"deleteAlbum",id:t.id},!0).then(h=>{if(!h)return f("error","Could not remove album, server returned false");O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.filter(E=>E.id!==t.id)),D.set(null)})}}]})}}]})},children:e(Te,{})})]})]}),e("div",{className:"name",style:{color:T.length<15?"var(--tablet-text-primary)":"#ffffff"},children:t.title})]}),g("div",{className:"library-content","data-offset":T.length<15,onScroll:b,"data-no-photos":N,children:[N&&g("div",{className:"no-photos",children:[e("div",{className:"title",children:i("APPS.PHOTOS.NO_PHOTOS")}),e("div",{className:"description",children:i("APPS.PHOTOS.NO_PHOTOS_INSTRUCTIONS")})]}),!a&&t.photoCount!==void 0&&!N&&e(te,{children:g("div",{className:"info",children:[i("APPS.PHOTOS.PHOTO_COUNT",{amount:t.photoCount.toString()}),", ",i("APPS.PHOTOS.VIDEO_COUNT",{amount:t.videoCount.toString()})]})}),e("div",{className:"library-grid",children:T.map((o,n)=>g("div",{id:n===0?"last":"",className:"grid-item",onClick:()=>{if(a){const c=s.find(h=>h.id===o.id);A(c?s.filter(h=>h.id!==o.id):[...s,o])}else k.set({activeImage:o,images:T})},children:[o.isVideo?e($,{src:o.src,showAdvanced:!a}):e("div",{className:"img",style:{backgroundImage:`url(${o.src})`}}),e("div",{className:"checkbox",children:a&&(s.find(c=>c.id===o.id)?e(K,{checked:!0}):e(K,{checked:!1}))})]},n))})]}),a&&g("div",{className:"select-footer",children:[e("div",{className:"icons","data-disabled":s.length===0,children:e(oe,{})}),e("div",{className:"title",children:s.length===0?i("APPS.PHOTOS.SELECT_ITEMS"):i("APPS.PHOTOS.SELECTED_COUNT",{count:s.length})}),g("div",{className:"icons","data-disabled":s.length===0,children:[e(ie,{onClick:()=>{if(s.length===0)return;let o=t.id!=="recents"&&t.id!=="favourites"&&t.id!=="phone";_.ContextMenu.set({title:o&&i("APPS.PHOTOS.DELETE_CONTEXT_TITLE",{type:s.length>1?i("APPS.PHOTOS.THESE_PHOTOS"):i("APPS.PHOTOS.THIS_PHOTO")}),buttons:[o&&{title:i("APPS.PHOTOS.REMOVE_FROM_ALBUM"),cb:()=>{M("Camera",{action:"removeFromAlbum",album:t.id,ids:s.map(n=>n.id)}).then(n=>{if(!n)return f("error","Could not remove from album, server returned false");let d=t.photoCount-s.filter(h=>!h.isVideo).length,c=t.videoCount-s.filter(h=>h.isVideo).length;O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(h=>{if(h.id===t.id)return{...h,count:h.count-s.length,photoCount:d,videoCount:c}})),D.set({...t,photoCount:d,videoCount:c}),I(T.filter(h=>!s.find(E=>h.id===E.id))),A([]),V.set(!1)})}},{title:i("APPS.PHOTOS.DELETE"),color:"red",cb:()=>{M("Camera",{action:"deleteFromGallery",ids:s.map(n=>n.id)},!0,t.id==="phone").then(n=>{if(!n)return f("error","Could not delete from gallery, server returned false");let d=0;s.forEach(E=>{d+=E.size}),window.postMessage({action:"phone:updateStorage",add:!1,size:d});let c=t.photoCount-s.filter(E=>!E.isVideo).length,h=t.videoCount-s.filter(E=>E.isVideo).length;M("Camera",{action:"getAlbums"}).then(E=>{if(!E)return f("error","No data received from server");let r=z.map(l=>{const P=E.mediaTypes.find(y=>y.id===l.id);return P?{...l,count:P.count}:l});O.APPS.CAMERA.albums.set(E.albums),O.APPS.CAMERA.mediaTypes.set(r)}),D.set({...t,photoCount:c,videoCount:h}),I(T.filter(E=>!s.find(r=>E.id===r.id))),A([]),V.set(!1)})}}]})}}),e(ce,{onClick:()=>{if(s.length===0)return;let o=s.find(n=>!n.favourite);_.ContextMenu.set({buttons:[t.id!=="phone"&&{title:i("APPS.PHOTOS.ADD_TO_ALBUM"),cb:()=>{Y.set({images:s,onSelect:n=>{M("Camera",{action:"addToAlbum",album:n.id,ids:s.map(d=>d.id)},!0).then(d=>{if(!d)return f("error","Could not add to album, server returned false");A([]),V.set(!1),O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(c=>c.id===n.id?{...c,count:c.count+s.length,photoCount:c.photoCount+s.filter(h=>!h.isVideo).length,videoCount:c.videoCount+s.filter(h=>h.isVideo).length,cover:s[s.length-1].src}:c))})}})}},t.id!=="phone"&&{title:o?i("APPS.PHOTOS.ADD_TO_FAVOURITES"):i("APPS.PHOTOS.REMOVE_FROM_FAVOURITES"),cb:()=>{M("Camera",{action:"toggleFavourites",ids:s.map(n=>n.id),favourite:!!o},!0).then(n=>{if(!n)return f("error","Could not add to favourites, server returned false");A([]),V.set(!1),O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(d=>d.id==="favourites"?{...d,count:d.count+s.length,photoCount:d.photoCount+s.filter(c=>!c.isVideo).length,videoCount:d.videoCount+s.filter(c=>c.isVideo).length,cover:s[s.length-1].src}:d))})}},t.id==="phone"&&{title:"Add to Tablet",cb:()=>{M("Camera",{action:"importFromPhone",ids:s.map(n=>n.id)},!0).then(n=>{if(!n)return f("error","Could not add to tablet, server returned false");A([]),V.set(!1),O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(d=>d.id==="recents"?{...d,count:d.count+s.length,photoCount:d.photoCount+s.filter(c=>!c.isVideo).length,videoCount:d.videoCount+s.filter(c=>c.isVideo).length,cover:s[s.length-1].src}:d))})}}]})}})]})]})]})};i("APPS.PHOTOS.YEARS"),i("APPS.PHOTOS.MONTHS"),i("APPS.PHOTOS.DAYS"),i("APPS.PHOTOS.ALL_PHOTOS");function He(){const t=R(V),[a,s]=C.useState([]),[A,T]=C.useState([]),[I,N]=C.useState(!1);C.useState("all");const[p,L]=C.useState(null),[x,m]=C.useState(!1),[F,u]=C.useState(!1);C.useState(0);const S=()=>{var y,H;let v=[],o=document.querySelectorAll(".grid-item");if(o.length===0||(o.forEach(B=>{!Z(B)&&v.push(B)}),v.length===0))return L(null);let n=v[0],d=parseInt(n==null?void 0:n.getAttribute("data-id"));if(!d)return;let c=(y=A.find(B=>B.id===d))==null?void 0:y.timestamp,h=v[v.length-1],E=parseInt(h.getAttribute("data-id")),r;if(E&&(r=(H=A.find(B=>B.id===E))==null?void 0:H.timestamp),!c)return;let l=b(c),P=b(r);if(l===P||!r)return L(l);L(`${l} - ${P}`)},b=v=>{let o=new Date(v),n=o.toLocaleString("default",{month:"short"}),d=o.getDate(),c=o.getFullYear();return`${d} ${n} ${c}`};C.useEffect(()=>{W("Photos")&&M("Camera",{action:"getImages"},w.Photos.sort((v,o)=>o.timestamp-v.timestamp).reverse()).then(v=>{if(!v)return f("warning","No data was returned from getImages event");T(v.reverse()),N(v.length===0)})},[]);const U=v=>{var d;if(S(),x||F)return;let o=document.querySelector("#last");if(!o)return;if(!Z(o)){const c=document.querySelector(".library-content");c||f("warning","Could not find library content element");const h=c==null?void 0:c.scrollHeight;u(!0),M("Camera",{action:"getImages",lastId:(d=A[0])==null?void 0:d.id},null).then(E=>{E&&E.length>0?(c.style.transform=`translateY(${h}px)`,T([...E.reverse(),...A]),u(!1),requestAnimationFrame(()=>{c.style.transition="transform 0ms",c.style.transform="translateY(0)"}),E.length<30&&m(!0)):m(!0)})}};return g(G.div,{...se("left","library"),className:"library-wrapper",children:[e("div",{className:"library-header",children:g("div",{className:"top",children:[e("div",{className:"info",children:e("div",{className:"date",style:{color:A.length<15?"var(--tablet-text-primary)":"#ffffff"},children:p&&p})}),e("div",{className:"actions",children:e("div",{className:"button",onClick:()=>V.set(!t),children:t?i("APPS.PHOTOS.DONE"):i("APPS.PHOTOS.SELECT")})})]})}),e("div",{className:"library-content","data-offset":A.length<15,onScroll:U,children:e("div",{className:"library-grid","data-zoomlevel":"5",children:A.map((v,o)=>g("div",{id:o===0?"last":"",className:"grid-item","data-id":v.id,onClick:()=>{if(t){const d=a.find(c=>c.id===v.id);s(d?a.filter(c=>c.id!==v.id):[...a,v])}else k.set({activeImage:v,images:A})},children:[v.isVideo?e($,{src:v.src,showAdvanced:!t}):e("div",{className:"img",style:{backgroundImage:`url(${v.src})`}}),e("div",{className:"checkbox",children:t&&(a.find(d=>d.id===v.id)?e(K,{checked:!0}):e(K,{checked:!1}))})]}))})}),t&&g("div",{className:"select-footer",children:[e("div",{className:"icons","data-disabled":a.length===0,children:e(oe,{})}),e("div",{className:"title",children:a.length===0?i("APPS.PHOTOS.SELECT_ITEMS"):i("APPS.PHOTOS.SELECTED_COUNT",{count:a.length})}),g("div",{className:"icons","data-disabled":a.length===0,children:[e(ie,{onClick:()=>{a.length!==0&&_.ContextMenu.set({buttons:[{title:i("APPS.PHOTOS.DELETE"),color:"red",cb:()=>{M("Camera",{action:"deleteFromGallery",ids:a.map(v=>v.id)},!0).then(()=>{T(A.filter(o=>!a.find(n=>o.src===n.src))),s([]);let v=0;a.forEach(o=>{v+=o.size}),window.postMessage({action:"phone:updateStorage",add:!1,size:v}),M("Camera",{action:"getAlbums"}).then(o=>{if(!o)return f("error","No data received from server");let n=z.map(d=>{const c=o.mediaTypes[d.id+"Photos"]??0,h=o.mediaTypes[d.id+"Videos"]??0;return{...d,count:c+h,photoCount:c,videoCount:h}});O.APPS.CAMERA.albums.set(o.albums),O.APPS.CAMERA.mediaTypes.set(n)})})}}]})}}),e(Me,{onClick:()=>{a.length!==0&&_.ContextMenu.set({buttons:[{title:i("APPS.PHOTOS.ADD_TO_ALBUM"),cb:()=>{Y.set({images:a,onSelect:v=>{M("Camera",{action:"addToAlbum",album:v.id,ids:a.map(o=>o.id)},!0).then(o=>{if(!o)return f("error","Could not add to album, server returned false");s([]),V.set(!1),O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(n=>n.id===v.id?{...n,count:n.count+a.length,photoCount:n.photoCount+a.filter(d=>!d.isVideo).length,videoCount:n.videoCount+a.filter(d=>d.isVideo).length,cover:a[a.length-1].src}:n))})}})}},{title:i("APPS.PHOTOS.ADD_TO_FAVOURITES"),cb:()=>{M("Camera",{action:"toggleFavourites",ids:a.map(v=>v.id),favourite:!0},!0).then(v=>{if(!v)return f("error","Could not add to favourites, server returned false");s([]),V.set(!1),O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(o=>o.id==="favourites"?{...o,count:o.count+a.length,photoCount:o.photoCount+a.filter(n=>!n.isVideo).length,videoCount:o.videoCount+a.filter(n=>n.isVideo).length,cover:a[a.length-1].src}:o))})}}]})}})]})]})]})}function _e(){var A,T,I;const t=R(Y),a=R(O.APPS.CAMERA.albums);let s=(A=t==null?void 0:t.images)==null?void 0:A[(t==null?void 0:t.images.length)-1];return g(G.div,{initial:{opacity:0,scale:.9,y:250},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:250},className:"addtoalbum-container",children:[g("div",{className:"addtoalbum-header",children:[e("div",{}),e("div",{className:"title",children:i("APPS.PHOTOS.ADD_TO_ALBUM")}),e("div",{className:"cancel",onClick:()=>Y.reset(),children:i("APPS.PHOTOS.CANCEL")})]}),g("div",{className:"addtoalbum-content",children:[g("div",{className:"preview",children:[j(s==null?void 0:s.src)?e($,{src:s==null?void 0:s.src,showAdvanced:!1}):e("img",{src:s==null?void 0:s.src}),e("div",{className:"title",children:i("APPS.PHOTOS.SELECTED_COUNT",{count:(T=t==null?void 0:t.images)==null?void 0:T.length})})]}),e("div",{className:"albums",children:(I=a==null?void 0:a.filter(N=>N.id!=="favourites"&&N.id!=="recents"))==null?void 0:I.map((N,p)=>g("div",{className:"album",onClick:()=>{t.onSelect(N),Y.reset()},children:[e("div",{className:"cover",children:j(N.cover)?e($,{src:N.cover,showAdvanced:!1}):e("img",{src:N.cover??"https://join.travelmanagers.com.au/wp-content/uploads/2017/09/default-placeholder-300x300.png"})}),e("div",{className:"title",children:N.title}),e("div",{className:"count",children:N.count})]},p))})]})]})}function Ue(){const t=R(ee),[a,s]=C.useState([{icon:e(Ie,{}),title:i("APPS.PHOTOS.LIBRARY"),value:"library"},{icon:e(Ne,{}),title:i("APPS.PHOTOS.ALBUMS"),value:"albums"}]);return e("div",{className:"photos-footer",children:a.map((A,T)=>g("div",{className:"item","data-active":t===A.value,onClick:()=>{ee.set(A.value),A.value==="albums"&&t==="albums"&&(D!=null&&D.value)&&D.reset()},children:[A.icon,A.title]},T))})}const ne=C.forwardRef((t,a)=>{const s=R(ue),[A,T]=C.useState(!0),[I,N]=C.useState(!0);return C.useEffect(()=>{ae(t.src,p=>{N(p),p||T(!1)})},[]),e("img",{...t,ref:a,src:I?t.src:"https://www.slntechnologies.com/wp-content/uploads/2017/08/ef3-placeholder-image.jpg","data-isblurred":s.streamerMode&&!t.ignoreStreamerMode&&A,onClick:p=>{if(s.streamerMode&&!t.ignoreStreamerMode&&A){p.preventDefault(),p.stopPropagation(),T(!1);return}t!=null&&t.onClick&&t.onClick()}})}),De=()=>{var c,h,E;const t=R(Q),a=R(ue),s=R(de),[A,T]=C.useState(!0),I=C.useRef(!1),[N,p]=C.useState(0),L=C.useRef(null),x=C.useRef(null),m=R(k),[F,u]=C.useState(new Date(((h=(c=k==null?void 0:k.value)==null?void 0:c.activeImage)==null?void 0:h.timestamp)??0)),[S,b]=C.useState(((E=m==null?void 0:m.activeImage)==null?void 0:E.favourite)??!1),[U,v]=C.useState([]);let o=(m==null?void 0:m.images)??[];C.useEffect(()=>{if(W("Photos"))return()=>{var r;if((r=m.activeImage)!=null&&r.isVideo){const l=document.getElementById(m.activeImage.id);if(!l)return;l.pause(),l.currentTime=0}}},[s==null?void 0:s.active]),C.useEffect(()=>{if(!(m!=null&&m.activeImage))return f("warning","No active image when changing volume");if(m.activeImage.isVideo){const r=document.getElementById(m.activeImage.id);if(!r)return;r.volume=a.sound.volume}},[a.sound.volume]),C.useEffect(()=>{var l;if(!m)return;let r=o.findIndex(P=>P.id===m.activeImage.id);if(p(r),b(m.activeImage.favourite),m.activeImage.isVideo){const P=document.getElementById(m.activeImage.id);if(!P)return f("warning","Video Element not found (Carousel effect)");P.play(),P.volume=a.sound.volume}if(o.length>0){let P=[];r===0?P=o.slice(0,12):r===o.length-1?P=o.slice(o.length-12,o.length):r<6?P=o.slice(0,12):r>o.length-6?P=o.slice(o.length-12,o.length):P=o.slice(r-6,r+6),u(new Date((l=o==null?void 0:o[r])==null?void 0:l.timestamp)),v(P)}},[m==null?void 0:m.activeImage]);const n={pos:{startLeft:0,startX:0},onMouseDown:r=>{n.pos={startLeft:L.current.scrollLeft,startX:r.clientX},L.current.style.userSelect="none",document.addEventListener("mouseup",n.onMouseUp),document.addEventListener("mousemove",n.onMove)},onMove:r=>{if(!L.current)return;const l=r.clientX-n.pos.startX;L.current.scrollLeft=n.pos.startLeft-l;const P=L.current.getBoundingClientRect();(P.left-5>r.clientX||r.clientX>P.right-5)&&n.onMouseUp(),I.current=!0},onMouseUp:()=>{if(!L.current)return;L.current.style.removeProperty("user-select"),document.removeEventListener("mouseup",n.onMouseUp),document.removeEventListener("mousemove",n.onMove);const r=L.current.clientWidth;let l=N;const P=L.current.scrollLeft-n.pos.startLeft;if(P>r/2&&l<o.length?l++:P<-r/2&&l>0&&l--,m.activeImage.id!==o[l].id&&m.activeImage.isVideo){const H=document.getElementById(m.activeImage.id);H&&(H.pause(),H.currentTime=0)}k.set({activeImage:o[l],images:o}),document.getElementById(o[l].id).scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{I.current=!1},100)}},d=r=>{m.activeImage.isVideo&&document.getElementById(m.activeImage.id).pause(),k.set({activeImage:r,images:o}),document.getElementById(r.id).scrollIntoView({behavior:"smooth",block:"center"})};return g(G.div,{initial:{opacity:0,scale:.5},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.25},className:"activephoto-container",children:[e(X,{children:A&&g(G.div,{className:"photo-top",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2,ease:"easeInOut"},children:[e("div",{className:"back",onClick:()=>{_.Share.reset(),k.reset()},children:e(le,{})}),g("div",{className:"date",children:[F.toLocaleString([],{day:"2-digit",month:"long"}),e("span",{children:F.toLocaleTimeString(t.DateLocale,{hour:"numeric",minute:"numeric",hour12:a.time.twelveHourClock})})]}),e("div",{children:e(ce,{onClick:()=>{_.ContextMenu.set({buttons:[{title:i("APPS.PHOTOS.ADD_TO_ALBUM"),cb:()=>{Y.set({images:[m.activeImage],onSelect:r=>{M("Camera",{action:"addToAlbum",album:r.id,ids:[m.activeImage.id]},!0).then(l=>{if(!l)return f("error","Could not add to album, server returned false");O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(P=>P.id===r.id?{...P,count:P.count+1,photoCount:m.activeImage.isVideo?P.photoCount:P.photoCount+1,videoCount:m.activeImage.isVideo?P.videoCount+1:P.videoCount,cover:m.activeImage.src}:P))})}})}},{title:S?i("APPS.PHOTOS.REMOVE_FROM_FAVOURITES"):i("APPS.PHOTOS.ADD_TO_FAVOURITES"),cb:()=>{M("Camera",{action:"toggleFavourites",ids:[m.activeImage.id],favourite:!S}).then(r=>{if(!r)return f("error","Could not add to favourites, server returned false");O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(l=>l.id==="favourites"?{...l,count:l.count+1,photoCount:m.activeImage.isVideo?l.photoCount:l.photoCount+1,videoCount:m.activeImage.isVideo?l.videoCount+1:l.videoCount,cover:m.activeImage.src}:l))})}}]})}})})]})}),e("div",{className:"image-overflow",ref:L,onMouseDown:n.onMouseDown,style:{backgroundColor:A?"var(--tablet-color-primary)":"rgba(0, 0, 0)"},onClick:()=>{I.current||T(!A)},children:o==null?void 0:o.map((r,l)=>{const P=r.id===m.activeImage.id;return r.isVideo?e("video",{id:r.id,src:r.src,className:P?"active":null,crossOrigin:"anonymous",loop:!0,onLoadedMetadata:y=>{P&&(y.target.scrollIntoView({block:"center"}),y.target.play())}},l):e(ne,{id:r.id,src:r.src,className:P?"active":null,ignoreStreamerMode:!0,onLoad:y=>{P&&y.target.scrollIntoView({block:"center"})}},l)})}),e(X,{children:A&&g(G.div,{className:"photo-bottom-wrapper",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2,ease:"easeInOut"},children:[e("div",{className:"photo-carousel",ref:x,children:U.map((r,l)=>r.isVideo?e("video",{src:r.src,"data-carousel":l,controls:!1,muted:!0,onClick:P=>d(r)},l):e(ne,{src:r.src,"data-carousel":l,onClick:P=>d(r)},l))}),g("div",{className:"photo-bottom",children:[e(oe,{onClick:()=>{_.Share.set({type:"image",data:{src:m.activeImage.src,isVideo:m.activeImage.isVideo}})}}),e("div",{onClick:()=>{M("Camera",{action:"toggleFavourites",ids:[m.activeImage.id],favourite:!S},!0).then(r=>{if(!r)return f("warning","Failed to toggle favourite, server returned success false");b(!S),O.APPS.CAMERA.albums.set(O.APPS.CAMERA.albums.value.map(l=>l.id==="favourites"?{...l,count:S?l.count-1:l.count+1,photoCount:m.activeImage.isVideo?l.photoCount:S?l.photoCount-1:l.photoCount+1,videoCount:m.activeImage.isVideo?S?l.videoCount-1:l.videoCount+1:l.videoCount,cover:m.activeImage.src}:l))})},children:S?e(re,{}):e(ye,{})}),e(ie,{onClick:()=>{_.PopUp.set({title:i("APPS.PHOTOS.DELETE_IMAGE_POPUP.TITLE"),description:i("APPS.PHOTOS.DELETE_IMAGE_POPUP.DESCRIPTION"),buttons:[{title:i("APPS.PHOTOS.DELETE_IMAGE_POPUP.CANCEL")},{title:i("APPS.PHOTOS.DELETE_IMAGE_POPUP.PROCEED"),color:"red",cb:()=>{M("Camera",{action:"deleteFromGallery",ids:[m.activeImage.id]},!0).then(r=>{if(!r)return f("error","Could not delete from gallery, server returned false");k.reset(),M("Camera",{action:"getAlbums"}).then(l=>{if(!l)return f("error","No data received from server");let P=z.map(y=>{const H=l.mediaTypes[y.id+"Photos"]??0,B=l.mediaTypes[y.id+"Videos"]??0;return{...y,count:H+B,photoCount:H,videoCount:B}});O.APPS.CAMERA.albums.set(l.albums),O.APPS.CAMERA.mediaTypes.set(P)})})}}]})}})]})]})})]})},ee=q("albums"),V=q(!1),k=q(null),Y=q(null),we={library:e(He,{}),albums:e(Re,{})},Be=[2,3,4,5];function ke(){const t=R(ee),a=R(k),s=R(V),A=R(Y);return g("div",{className:"photos-container",children:[e("div",{className:"photos-content",style:{pointerEvents:a?"none":"all"},children:we[t]}),!s&&e(Ue,{}),e(X,{children:a&&e(De,{})}),e(X,{children:A&&e(_e,{})})]})}export{k as ActiveImage,Y as AlbumPickerComponent,V as SelectMode,ee as View,ke as default,Be as zoomLevels};
